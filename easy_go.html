<!DOCTYPE html> 
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Easy Go!</title>
<link href="http://code.jquery.com/mobile/1.0/jquery.mobile-1.0.min.css" rel="stylesheet" type="text/css"/>
<script src="http://code.jquery.com/jquery-1.7.min.js" type="text/javascript"></script>
<script src="http://code.jquery.com/mobile/1.0/jquery.mobile-1.0.min.js" type="text/javascript"></script>
<script src="http://maps.google.com/maps/api/js?libraries=geometry&sensor=true"></script>
<style>
#map-page{ width: 100%; height: 1920px; padding: 0; }
#map-canvas {height: 400px;}
#map-text{overflow: hidden;}
</style>
</head> 
<body> 

<div data-role="page" id="map-page">
	<div data-role="header">
		<h1>Easy Go!</h1>
	</div>
	<div data-role="content" id="map-text">	
		起點：<br><br>
        <input type="text" id="start">
        <a href="#" data-role="button" id="d1" data-inline="true">現在位置</a>
        <a href="#" data-role="button" id="b1" data-inline="true">確認起點</a>
        <br><br>
        終點：<br><br>
        <input type="text" id="end">
        <a href="#" data-role="button" id="d2" data-inline="true">現在位置</a>
        <a href="#" data-role="button" id="b2" data-inline="true">確認終點</a><br><br>
        路點關鍵字搜尋：<br><br>
        <input type="search" name="keyword" id="key"><br><br>
        路點類型：<br><br>
        <select name="category" id="cate">
      			<option value="all">全部</option>
                <option value="Local business">地方商務</option>
      			<option value="Restaurant/cafe">餐廳/Cafe</option>
      			<option value="Hotel">旅館</option>
                <option value="Travel/leisure">休閒</option>
                <option value="School">學校</option>
                <option value="Landmark">地標</option>
                <option value="Tours/sightseeing">觀光</option>
                <option value="Arts/entertainment/nightlife"> 藝術/娛樂/夜生活</option>
                <option value="Shopping/retail">購物</option>
                <option value="Health/beauty">健康/美容</option>
                <option value="Food/grocery">食品/雜貨</option>
                <option value="Food/beverages"> 食品/飲料</option>
                <option value="Clothing">服飾</option>
                <option value="Church/religious organization">教堂/宗教組織</option>
                <option value=" Museum/art gallery">博物館/藝廊</option>
                <option value="Sports venue">體育館</option>
                <option value="Bar">酒吧</option>
                <option value="Club">俱樂部</option>
                <option value="Library">圖書館</option>
                <option value="Retail and consumer merchandise">零售商店</option>
                <option value="Book store"> 書店</option>
                <option value="Government organization"> 政府組織</option>
                <option value="Movie theater"> 電影院</option>
                <option value="Jewelry/watches"> 珠寶/手錶</option>
                <option value="Hospital/clinic"> 醫院/診所</option>     
    	</select><br>

        <a href="#" data-role="button" id="rwp">列出路點</a><br>
        <div id="selectList">
        </div>
        <a href="#" data-role="button" id="r1">路徑規劃</a>
	</div>
    <div role="main" class="ui-content" id="map-canvas">
    </div>
	<div data-role="footer">
		<h4>NTUIM 2014</h4>
	</div>
</div>

<script>
var geocoder;
var map;
var directionsService;
var directionsDisplay;
var marker_s;
var marker_e;
var sp=null;
var ep=null;


$( document ).on( "pageinit", "#map-page", function() {
    var defaultLatLng = new google.maps.LatLng(25.047968, 121.517081); 
	geocoder = new google.maps.Geocoder();
	directionsService = new google.maps.DirectionsService();
    
    drawMap(defaultLatLng); 
});

function drawMap(latlng) {
        var myOptions = {
            zoom: 15,
            center: latlng,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
       map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);
    }

$("#d1").on( "click",function() {
    if ( navigator.geolocation ) {
        function success(pos) {
			 var latlng = new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
			 geocoder.geocode({'latLng': latlng}, function(results, status) {
     			 if (status == google.maps.GeocoderStatus.OK) {
        			if (results[0]) {
				     $("#start").val(results[0].formatted_address);
					}
                 } else {
                    alert("Geocoder failed due to: " + status);
                 }
             });
        }
        function fail(error) {
            alert("定位失敗!")
        }
        // Find the users current position.  Cache the location for 5 minutes, timeout after 6 seconds
        navigator.geolocation.getCurrentPosition(success, fail, {maximumAge: 500000, enableHighAccuracy:true, timeout: 6000});
    } else {
        alert("瀏覽器不支援或未開啟定位功能")
    }
});
		
$("#d2").on( "click",function() {
	  if ( navigator.geolocation ) {
        function success(pos) {
			var latlng = new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
			 geocoder.geocode({'latLng': latlng}, function(results, status) {
     			 if (status == google.maps.GeocoderStatus.OK) {
        			if (results[0]) {
				     $("#end").val(results[0].formatted_address);
					}
                 } else {
                    alert("Geocoder failed due to: " + status);
                 }
             });
        }
        function fail(error) {
            alert("定位失敗!")
        }
        // Find the users current position.  Cache the location for 5 minutes, timeout after 6 seconds
        navigator.geolocation.getCurrentPosition(success, fail, {maximumAge: 500000, enableHighAccuracy:true, timeout: 6000});
    } else {
        alert("瀏覽器不支援或未開啟定位功能")
    }          
});
		
$("#b1").on( "click",function() {
   var address = $("#start").val();
    geocoder.geocode( { 'address': address}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        map.setCenter(results[0].geometry.location);
        if(marker_s!=null)
		{
			marker_s.setMap(null);
			google.maps.event.trigger(map, "resize");
		}
		marker_s = new google.maps.Marker({
            map: map,
            position: results[0].geometry.location
        });
		sp=results[0].geometry.location;
		
      } else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    });
});
		
$("#b2").on( "click",function() {
   var address = $("#end").val();
    geocoder.geocode( { 'address': address}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        map.setCenter(results[0].geometry.location);
		if(marker_e!=null)
		{
			marker_e.setMap(null);
			google.maps.event.trigger(map,"resize");
		}
        marker_e = new google.maps.Marker({
            map: map,
            position: results[0].geometry.location
        });
		ep=results[0].geometry.location;
      } else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    });
});
		
$("#r1").on( "click",function() {
        var request = {
                origin: $("#start").val(),
                destination: $("#end").val(),
                travelMode: google.maps.TravelMode.WALKING
        };
		
		directionsService.route(request, function(response, status) {
                //規畫路徑回傳結果
                if (status == google.maps.DirectionsStatus.OK) {
						if(directionsDisplay!=null)
						{
							directionsDisplay.setMap(null);
							google.maps.event.trigger(map,"resize");
						}
						
						if(marker_s!=null)
						{
							marker_s.setMap(null);
							google.maps.event.trigger(map,"resize");
						}
						
						if(marker_e!=null)
						{
							marker_e.setMap(null);
							google.maps.event.trigger(map,"resize");
						}
	
    					directionsDisplay = new google.maps.DirectionsRenderer();
						
						directionsDisplay.setMap(map);
						
                        directionsDisplay.setDirections(response);
                }
        });
});

$("#rwp").on( "click",function() {
	
	        if((sp!=null)&&(ep!=null)){
                       $.ajax(
				 			{   url: '/proxy.php',
							    //async: false,
				     			type: 'GET',
	  				 			dataType: "json",
                     
                     			success: function(Jdata) { 
								 var dts;
								 var center;
								 var rad;
								 var li=20;
								 var tk=Jdata.result.token;						 
								 
								 if((ep.lat()==sp.lat())&&(ep.lng()==sp.lng())){
									 
								   center=sp.lat()+','+sp.lng(); 
								   rad=3;
								 
								   if(($("#key").val()=='')&&($("#cate").val()=='all')){
									 dts={ coordinates: center, radius: rad, limit: li ,token:tk,keyword:"",                                      category:""};
							       }else if(($("#key").val()!='')&&($("#cate").val()=='all')){
									 dts={ coordinates: center, radius: rad, limit: li ,token:tk,keyword:$("#key").val(),                                      category:""};
								   }else if(($("#key").val()=='')&&($("#cate").val()!='all')){
									 dts={ coordinates: center, radius: rad, limit: li ,token:tk,keyword:"",                                      category:$("#cate").val()};
								   }else if(($("#key").val()!='')&&($("#cate").val()!='all')){
									 dts={ coordinates: center, radius: rad, limit: li ,token:tk,keyword:$("#key").val(),                                      category:$("#cate").val() };
								   }
								 }else{
									
									 var lt=(sp.lat()+ep.lat())/2;
									 var lg=(sp.lng()+ep.lng())/2
									 
									 var step3=google.maps.geometry.spherical.computeDistanceBetween(sp,ep)/1000/2;
									 if(step3<1){step3=1;}
								   alert(step3);
								   
								   center=lt+','+lg; 
								   rad=step3;
								 
								   if(($("#key").val()=='')&&($("#cate").val()=='all')){
									 dts={ coordinates: center, radius: rad, limit: li ,token:tk,keyword:"",                                      category:""};
							       }else if(($("#key").val()!='')&&($("#cate").val()=='all')){
									 dts={ coordinates: center, radius: rad, limit: li ,token:tk,keyword:$("#key").val(),                                      category:""};
								   }else if(($("#key").val()=='')&&($("#cate").val()!='all')){
									 dts={ coordinates: center, radius: rad, limit: li ,token:tk,keyword:"",                                      category:$("#cate").val()};
								   }else if(($("#key").val()!='')&&($("#cate").val()!='all')){
									 dts={ coordinates: center, radius: rad, limit: li ,token:tk,keyword:$("#key").val(),                                      category:$("#cate").val() };
								   }
								   
								 }
								 
								 	$.ajax(
				 						{   url: '/proxy2.php',
							    			//async: false,
				     						type: 'POST',
											data:dts,
	  				 						dataType: "json",
                     						success: function(Jdata2) { 
											
											var rst=Jdata2.message;
											var ctr=Jdata2.total;
											var localName=[];
											var localLat=[];
											var localLng=[];
											var check=[];
											
											for(i=0;i<ctr;i++){
							                    localLat[i]=Jdata2.result[i].latitude;
												localLng[i]=Jdata2.result[i].longitude;
												check[i]=Jdata2.result[i].checkins;
												localName[i]=Jdata2.result[i].name;
												localName[i]=localName[i].replace(/\\/g,"%");
												localName[i]=decodeURI(localName[i]);	
											}
											
											$("#selectList").html('');
											
											if(rst=='no result'){
											  $("#selectList").append('沒有找到任何路點');
											}else if(rst=='success')
											{
											  $("#selectList").append('找到'+ctr+'個路點');
											  $("#selectList").append('<select id="wpse" name="wpsen" multiple="multiple" data-native-menu="false"><option>請選擇最多六個路點</option></select>');
											 
											  
											  for(i=0;i<ctr;i++){
							                    $("#wpse").append('<option value="'+localLat[i]+','+localLng[i]+'">'+localName[i]+'&nbsp;&nbsp;&nbsp;&nbsp;人氣度:'+check[i]+'</option>');												
											  }
											  
											  //$("#wpse").trigger("create");
											  $("#selectList").trigger("create");
											}
											
											
											
											},
											error: function(xhr, ajaxOptions, thrownError) {
									           alert(thrownError);
                     			            }
									     });
								 
								 
                    			 },
                     			error: function(xhr, ajaxOptions, thrownError) {
									alert(thrownError);
                     			}
                 		 });
			}

});

</script>

</body>
</html>
