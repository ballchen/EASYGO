<!DOCTYPE html> 
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Easy Go!</title>
<link href="http://code.jquery.com/mobile/1.0/jquery.mobile-1.0.min.css" rel="stylesheet" type="text/css"/>
<script src="http://code.jquery.com/jquery-1.7.min.js" type="text/javascript"></script>
<script src="http://code.jquery.com/mobile/1.0/jquery.mobile-1.0.min.js" type="text/javascript"></script>
<script src="http://maps.google.com/maps/api/js?sensor=true"></script>
<style>
#map-page{ width: 100%; height: 100%; padding: 0; }
#map-canvas {height: 50%}
#map-text{overflow: hidden;}
</style>
</head> 
<body> 

<div data-role="page" id="map-page">
	<div data-role="header">
		<h1>Easy Go!</h1>
	</div>
	<div data-role="content" id="map-text">	
		起點：<br><br>
        <input type="text" id="start">
        <a href="#" data-role="button" id="d1" data-inline="true">現在位置</a>
        <a href="#" data-role="button" id="b1" data-inline="true">標記起點</a>
        <br><br>
        終點：<br><br>
        <input type="text" id="end">
        <a href="#" data-role="button" id="d2" data-inline="true">現在位置</a>
        <a href="#" data-role="button" id="b2" data-inline="true">標記終點</a><br><br>
        <a href="#" data-role="button" id="r1">路徑規劃</a>
	</div>
    <div role="main" class="ui-content" id="map-canvas">
    </div>
	<div data-role="footer">
		<h4>NTUIM 2014</h4>
	</div>
</div>

<script>
var geocoder;
var map;
var directionsService;
var directionsDisplay;


$( document ).on( "pageinit", "#map-page", function() {
    var defaultLatLng = new google.maps.LatLng(25.047968, 121.517081); 
	geocoder = new google.maps.Geocoder();
	directionsService = new google.maps.DirectionsService();
	 
	var rendererOptions = {
                suppressMarkers: true
        };
 
    directionsDisplay = new google.maps.DirectionsRenderer(rendererOptions);
    
    drawMap(defaultLatLng); 
	
	directionsDisplay.setMap(map);
});

function drawMap(latlng) {
        var myOptions = {
            zoom: 15,
            center: latlng,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
       map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);
    }

$("#d1").on( "click",function() {
    if ( navigator.geolocation ) {
        function success(pos) {
			 var latlng = new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
			 geocoder.geocode({'latLng': latlng}, function(results, status) {
     			 if (status == google.maps.GeocoderStatus.OK) {
        			if (results[0]) {
				     $("#start").val(results[0].formatted_address);
					}
                 } else {
                    alert("Geocoder failed due to: " + status);
                 }
             });
        }
        function fail(error) {
            alert("定位失敗!")
        }
        // Find the users current position.  Cache the location for 5 minutes, timeout after 6 seconds
        navigator.geolocation.getCurrentPosition(success, fail, {maximumAge: 500000, enableHighAccuracy:true, timeout: 6000});
    } else {
        alert("瀏覽器不支援或未開啟定位功能")
    }
});
		
$("#d2").on( "click",function() {
	  if ( navigator.geolocation ) {
        function success(pos) {
			var latlng = new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
			 geocoder.geocode({'latLng': latlng}, function(results, status) {
     			 if (status == google.maps.GeocoderStatus.OK) {
        			if (results[0]) {
				     $("#end").val(results[0].formatted_address);
					}
                 } else {
                    alert("Geocoder failed due to: " + status);
                 }
             });
        }
        function fail(error) {
            alert("定位失敗!")
        }
        // Find the users current position.  Cache the location for 5 minutes, timeout after 6 seconds
        navigator.geolocation.getCurrentPosition(success, fail, {maximumAge: 500000, enableHighAccuracy:true, timeout: 6000});
    } else {
        alert("瀏覽器不支援或未開啟定位功能")
    }          
});
		
$("#b1").on( "click",function() {
   var address = $("#start").val();
    geocoder.geocode( { 'address': address}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        //map.setCenter(results[0].geometry.location);
        var marker = new google.maps.Marker({
            map: map,
            position: results[0].geometry.location
        });
      } else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    });
});
		
$("#b2").on( "click",function() {
   var address = $("#end").val();
    geocoder.geocode( { 'address': address}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        //map.setCenter(results[0].geometry.location);
        var marker = new google.maps.Marker({
            map: map,
            position: results[0].geometry.location
        });
      } else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    });
});
		
$("#r1").on( "click",function() {
        var request = {
                origin: $("#start").val(),
                destination: $("#end").val(),
                travelMode: google.maps.TravelMode.WALKING
        };
		
		directionsService.route(request, function(response, status) {
                //規畫路徑回傳結果
                if (status == google.maps.DirectionsStatus.OK) {
                        directionsDisplay.setDirections(response);
                }
        });
});
		
</script>

</body>
</html>
